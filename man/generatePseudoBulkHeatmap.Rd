% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/generate_unity_heatmap.R
\name{generatePseudoBulkHeatmap}
\alias{generatePseudoBulkHeatmap}
\title{Create Unity or Z-score Normalized Heatmap by Subject, Disease, and Cell Type}
\usage{
generatePseudoBulkHeatmap(
  seurat_obj,
  celltypes_to_plot,
  genes_for_heatmap,
  Cell_Colors,
  disease_colors,
  subject_colors,
  celltype_column,
  disease_column,
  subject_column = "orig.ident",
  assay = "RNA",
  min.cells.per.subject = 3,
  cores = 10,
  pdf_filename = "heatmap.pdf",
  png_filename = "heatmap.png",
  normalization_method = "unity",
  zscore_colors = circlize::colorRamp2(c(-1, 0, 1), c("blue", "white", "red")),
  verbose = TRUE
)
}
\arguments{
\item{seurat_obj}{A Seurat object containing the single-cell RNA-seq data.
The specified \code{assay} should contain the expression data (e.g., counts,
normalized data).}

\item{celltypes_to_plot}{A character vector specifying the cell types
(matching values in \code{celltype_column}) to include in the heatmap.}

\item{genes_for_heatmap}{A character vector of gene names to display
in the heatmap rows. Genes not found in the Seurat object will be skipped.}

\item{Cell_Colors}{A named vector or list providing color codes for each
cell type specified in \code{celltypes_to_plot}. Names should match the cell types.}

\item{disease_colors}{A named vector or list providing color codes for each
disease status level (e.g., \code{c(CTRL = "blue", PAH = "red")}). Names should
match the levels in \code{disease_column}.}

\item{subject_colors}{A named vector or list providing color codes for each
subject ID (values in \code{subject_column}). Names should match the subject IDs.}

\item{celltype_column}{A character string specifying the column name in
\code{seurat_obj@meta.data} that contains cell type annotations.}

\item{disease_column}{A character string specifying the column name in
\code{seurat_obj@meta.data} that contains disease status annotations (e.g., "CTRL", "PAH").}

\item{subject_column}{A character string specifying the column name in
\code{seurat_obj@meta.data} that contains subject IDs (e.g., "orig.ident", "patient_id").
Defaults to "orig.ident".}

\item{assay}{A character string specifying the name of the assay in the Seurat
object containing the expression data to use. Defaults to "RNA".}

\item{min.cells.per.subject}{An integer specifying the minimum number of cells
required for a specific cell type within a specific subject under a specific
disease condition to be included in the pseudo-bulk calculation. Defaults to 3.
Combinations with fewer cells are excluded.}

\item{cores}{An integer specifying the number of cores to use for parallel
processing (\code{mclapply}). Defaults to 10. Note: \code{mclapply} only works on
Linux/macOS, not Windows. Consider using \code{BiocParallel} for cross-platform compatibility.}

\item{pdf_filename}{A character string specifying the filename for the output
PDF heatmap. Defaults to "heatmap.pdf".}

\item{png_filename}{A character string specifying the filename for the output
PNG heatmap. Defaults to "heatmap.png".}

\item{normalization_method}{A character string specifying the normalization
method to apply to the heatmap data. Can be "unity" (0-1 scaling) or "zscore".
Defaults to "unity".}

\item{zscore_colors}{A color ramp function or a vector of colors to use for
the heatmap when \code{normalization_method} is "zscore". If a vector, a color
interpolation function will be created. Defaults to a divergent color scale
(\code{circlize::colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))}).}

\item{verbose}{A logical value indicating whether to print progress messages
and warnings (e.g., skipped genes, filtered combinations). Defaults to TRUE.}
}
\value{
Invisibly returns the \code{Heatmap} object created by the
\code{ComplexHeatmap} package. This allows further modification or drawing
of the heatmap object if needed.
}
\description{
This function generates a heatmap visualizing gene expression patterns across
specified cell types, conditions (diseases), and subjects. It calculates
pseudo-bulk expression profiles by averaging gene expression within each
unique combination of cell type, disease status, and subject ID, applying
a minimum cell count filter per combination. The resulting matrix can be
normalized using either Unity (0-1 scaling) or Z-score normalization.
}
\details{
The function performs the following steps:
\enumerate{
\item Validates inputs, including checking for the existence of specified columns
and the assay, and filters genes present in the Seurat object.
\item Identifies unique combinations of cell type, disease status, and subject ID
based on the specified metadata columns.
\item Filters these combinations based on \code{min.cells.per.subject}. Combinations
with fewer cells are excluded from further analysis and the heatmap.
\item For each valid combination, calculates the average expression (pseudo-bulk)
of the specified \code{genes_for_heatmap} using cells belonging to that combination.
Uses \code{Matrix::rowMeans} for efficiency with sparse matrices.
\item Collates the pseudo-bulk profiles into a matrix.
\item Normalizes the pseudo-bulk matrix row-wise (per gene) using the specified
\code{normalization_method}. "unity" scales values between 0 and 1. "zscore"
calculates the standard score for each value relative to the gene's mean
and standard deviation across all samples. Genes with constant expression
(zero range or standard deviation) are normalized to 0.
\item Creates column annotations for the heatmap based on cell type, disease,
and subject, using the provided color mappings.
\item Orders the heatmap columns based on cell type, then disease, then subject ID
according to the levels found in the filtered data and the order of
\code{celltypes_to_plot}.
\item Generates the heatmap using \code{ComplexHeatmap::Heatmap}, disabling column clustering
and splitting columns by cell type. The color scale used depends on the
\code{normalization_method} and the \code{zscore_colors} parameter if applicable.
\item Saves the heatmap to both PDF and PNG files.
}

\strong{Notes:}
\itemize{
\item The function name \code{generate_Unity_heatmap} uses dots and reflects only one
normalization method. Consider renaming to \code{generatePseudoBulkHeatmap} or
\code{generate_pseudo_bulk_heatmap} for better clarity and style consistency.
\item Parallel processing uses \code{parallel::mclapply}, which is not available on Windows.
For cross-platform compatibility in a package, consider alternatives like
\code{BiocParallel::bplapply} or adding an option for sequential processing.
}
}
